
<h2><br>Introduction</h2>



<p>Depuis la version 7.4 de PHP nous avons enfin acc√®s aux fonctions d&rsquo;interop√©rabilit√© entre les diff√©rents languages et PHP:&nbsp;le FFI ou<a href="https://en.wikipedia.org/wiki/Foreign_function_interface"> Foreign </a><a href="https://en.wikipedia.org/wiki/Foreign_function_interface" target="_blank" rel="noreferrer noopener">function</a><a href="https://en.wikipedia.org/wiki/Foreign_function_interface"> interface</a>.</p>



<p><strong>FFI c&rsquo;est quoi&nbsp;?&nbsp;</strong><br>C&rsquo;est tout simplement la possibilit√© d&rsquo;utiliser une librairie externe&nbsp;(.dll ou&nbsp;.so)&nbsp;directement dans PHP,&nbsp;et ce,&nbsp;sans avoir √† cr√©er un module PHP.&nbsp;<br>Oui oui,&nbsp;juste avec un script PHP !&nbsp;<br>C&rsquo;est entre autre ce qui √† fait la gloire de python et lui a permis d&rsquo;avoir tant de fonctionnalit√©s.</p>



<p>Ce qui est g√©nial avec FFI c&rsquo;est qu&rsquo;un d√©veloppeur PHP non-expert en C/Rust/Go/Kotlin&nbsp;(liste non exhaustive)&nbsp;peut enfin lier une librairie externe par lui m√™me.&nbsp;Ainsi,&nbsp;si vous avez un projet avec un besoin hyper sp√©cifique,&nbsp;une lib propri√©taire ou que sais-je encore et que vous n&rsquo;avez pas trop de charge vous pouvez directement vous coller au dev de l&rsquo;utilisation de celle-ci.&nbsp;<br>√áa arrive rarement,&nbsp;mais ici chez partITech, √ßa nous est quand m√™me arriv√© de devoir d√©velopper des module PHP.&nbsp;Du coup,&nbsp;le fait de d√©velopper directement la liaison avec la lib en PHP devrait rendre la proc√©dure bien plus simple et rapide √† d√©ployer.</p>



<p>Bien entendu ce jeu de fonction a un co√ªt car,&nbsp;m√™me si la proc√©dure permet d&rsquo;aller plus vite en d√©veloppement, elle reste moins rapide qu&rsquo;un vrai module PHP √©crit en c/c++.&nbsp;<br>En effet,&nbsp;acc√©der aux structures avec FFI est pour le moment 2 fois moins rapide qu&rsquo;avec un module natif.&nbsp;Il n&rsquo;est donc pas recommand√© d&rsquo;utiliser FFI pour am√©liorer les performances de votre application.&nbsp;En revanche,&nbsp;il peut grandement vous aider √† r√©duire la m√©moire utilis√©e sur des process tr√®s gourmands.&nbsp;(source&nbsp;<a href="https://www.php.net/manual/fr/intro.ffi.php" target="_blank" rel="noreferrer noopener">https://www.php.net/manual/fr/intro.ffi.php</a>).</p>



<p>Bon, les intros et les blah-blah tr√®s peu pour nous.&nbsp;Ce qu&rsquo;on veut voir c&rsquo;est du code.&nbsp;<br>Donc je vous propose de voir plusieurs probl√©matiques rencontr√©es lors de nos tests.&nbsp;Bien entendu chaque projet est diff√©rent mais si cet article peut vous aider √† mettre les mains dans le ¬´¬†bousin¬†¬ª on sera content.</p>



<p></p>



<h2>Le hello world</h2>



<p>Le test basique de r√©f√©rence restant le fameux ¬´¬†Hello world¬†¬ª, nous allons d√©buter notre voyage dans le monde merveilleux des FFI avec une fonction C qui va nous retourner ¬´¬†Hello world¬†¬ª.</p>



<p><strong>hello.c</strong></p>



<pre class="wp-block-code"><code lang="c" class="language-c">#include &lt;stdio.h&gt;

 const char * hello() {
   return "Hello, World!";
}</code></pre>



<p><strong>hello.h</strong></p>



<pre class="wp-block-code"><code lang="c" class="language-c">export const char * hello();</code></pre>



<p>On peut √† pr√©sent compiler.</p>



<pre class="wp-block-code"><code lang="bash" class="language-bash">gcc -c hello.c</code></pre>



<p>On demande √† gcc de nous cr√©er notre librairie partag√©e, le fameux fichier&nbsp;.so</p>



<pre class="wp-block-code"><code lang="bash" class="language-bash">gcc -shared -o hello.so hello.o
</code></pre>



<p>Voil√† ! A pr√©sent nous avons notre mati√®re pour jouer avec PHP-ffi directement.</p>



<p>Voici le code PHP nous permettant d&rsquo;appeler notre fonction hello()</p>



<p><strong>hello.php</strong></p>



<pre class="wp-block-code"><code lang="php" class="language-php line-numbers">#!/usr/bin/php8.1
&lt;?php
$ffi = FFI::cdef(
    "const char *hello();",
    __DIR__ ."/hello.so"
);

echo $ffi-&gt;hello();</code></pre>



<pre class="wp-block-code"><code lang="bash" class="language-bash">chmod +x hello.php
./hello.php
Hello, World!</code></pre>



<p><strong>Explications&nbsp;:</strong></p>



<p>La m√©thode <strong>cdef</strong> nous permet de cr√©er un nouvel objet FFI.&nbsp;Le premier param√®tre est une cha√Æne contenant la d√©finition de notre librairie.&nbsp;On est pas oblig√© de mettre l‚Äôint√©gralit√© des informations de la librairie,&nbsp;seulement ce qui nous int√©resse.</p>



<p>A noter que si vous utilisez des header files un peu complexe, il y a de fortes chances pour que √ßa plante directement.&nbsp;De ce que j&rsquo;ai pu utiliser,&nbsp;j&rsquo;ai syst√©matiquement recr√©√© et simplifi√© les fichiers de d√©finitions.&nbsp;<br>Nous verrons dans un autre exemple comment cr√©er et utiliser directement un header file un peu trop gros pour √™tre pos√© directement dans notre script.&nbsp;√áa peut rapidement devenir compliqu√©&nbsp;üôÇ</p>



<p>Le second param√®tre est notre librairie partag√©e.&nbsp;Pas vraiment besoin d&rsquo;expliquer.</p>



<p>Finalement on va directement appeler la fonction et faire un echo du r√©sultat.</p>



<p>Simple&#8230;Basique.</p>



<p>On passe √† un exemple un petit peu plus pouss√©&nbsp;? Rendez vous dans la seconde partie de notre dossier sur le monde merveilleux des Foreign Function Interfaces.</p>



<p><a href="/php-ffi/php-ffi-partie-2">PHP FFI: Passage de param√®tres et utilisation le zend engine &#8211; partie 2</a></p>



<p></p>



<p>Merci √† <a href="https://www.linkedin.com/in/thomas-bourdin-b332b630/">Thomas Bourdin</a>, <a href="https://www.linkedin.com/in/lejallec/">C√©dric Le Jall√©</a>, <a href="https://www.linkedin.com/in/stephanepechard/">St√©phane P√©chard</a> pour leur aide, conseils et relecture.</p>
